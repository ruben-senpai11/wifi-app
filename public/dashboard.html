<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WiFi Portal</title>
  <link rel="shortcut icon" href="/icon.png" type="image/x-icon">
  <link rel="stylesheet" href="/public/assets/css/main.css">
  <script src="/public/assets/scripts/tailwind.js"></script>
  <script src="/public/assets/scripts/typescript.min.js"></script>
  <style type="text/tailwindcss">
    svg{
      width: 70px;
      height: 70px;
      padding: 0px 8px;
      margin-right: 8px;
      /* margin: 0px 8px; */
      background-color: purple;
      color: oklch(0.905 0.182 98.111);
      border-radius: 8px;
      box-shadow: 0 0 2px black;
    }

    .container{
        overflow: auto;
    }
    @media (max-width:1030px) {
      .container{
        width: 100%;
        max-width: 100%;
      }
    }
    @media (max-width:758px) {
      nav a{
        font-size: 20px;
      }
      nav button{
        font-size: 14px;
        padding: 4px 8px;
      }
      .p-12{
        padding: 2% 4%;
      }
      h1{
        font-size: 24px;
      }
      
      svg{
        width: 40px;
        height: 40px;
      }
      .container{
        padding: 5% 2%;
      }
      .d-wrapper{
        padding: 10% 4%;
      }
      .d-wrapper th:nth-child(1), .d-wrapper td:nth-child(1){
        display: none;
      }
    }

    @media (max-width:404px) {
      svg{
      width: 50px;
      height: 50px;
      }
    }
  </style>

</head>

<body class="bg-sky-700 ">

  <nav class="dashboard flex justify-between items-center bg-yellow-300 text-sky-700 p-12 py-3 ">
    <a href="/" class="text-2xl font-bold">Panneau d'Administration</a>
    <div class="flex justify-between items-center">
      <!-- <a href="/" class="px-4 py-2 bg-red-500 font-bold rounded text-white">
        Déconnexion
      </a> -->
      <button id="logout" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 cursor-pointer rounded">
        Déconnexion
      </button>
    </div>
  </nav>

  <div class="d-wrapper flex flex-col items-start justify-center gap-24 p-12 pb-4 ">
    <h1 class="text-5xl font-bold text-yellow-300 flex justify-center items-center gap-2 ">
      <svg fill="currentColor" version="1.1" id="Capa_1" viewBox="0 0 365.892 365.892" xml:space="preserve">
        <g>
          <circle cx="182.945" cy="286.681" r="41.494" />
          <path
            d="M182.946,176.029c-35.658,0-69.337,17.345-90.09,46.398c-5.921,8.288-4.001,19.806,4.286,25.726   c3.249,2.321,6.994,3.438,10.704,3.438c5.754,0,11.423-2.686,15.021-7.724c13.846-19.383,36.305-30.954,60.078-30.954   c23.775,0,46.233,11.571,60.077,30.953c5.919,8.286,17.437,10.209,25.726,4.288c8.288-5.92,10.208-17.438,4.288-25.726   C252.285,193.373,218.606,176.029,182.946,176.029z" />
          <path
            d="M182.946,106.873c-50.938,0-99.694,21.749-133.77,59.67c-6.807,7.576-6.185,19.236,1.392,26.044   c3.523,3.166,7.929,4.725,12.32,4.725c5.051-0.001,10.082-2.063,13.723-6.116c27.091-30.148,65.849-47.439,106.336-47.439   s79.246,17.291,106.338,47.438c6.808,7.576,18.468,8.198,26.043,1.391c7.576-6.808,8.198-18.468,1.391-26.043   C282.641,128.621,233.883,106.873,182.946,106.873z" />
          <path
            d="M360.611,112.293c-47.209-48.092-110.305-74.577-177.665-74.577c-67.357,0-130.453,26.485-177.664,74.579   c-7.135,7.269-7.027,18.944,0.241,26.079c3.59,3.524,8.255,5.282,12.918,5.281c4.776,0,9.551-1.845,13.161-5.522   c40.22-40.971,93.968-63.534,151.344-63.534c57.379,0,111.127,22.563,151.343,63.532c7.136,7.269,18.812,7.376,26.08,0.242   C367.637,131.238,367.745,119.562,360.611,112.293z" />
        </g>
      </svg>
      Mon WIFI Moderne
    </h1>
    <div
      class="container w-full p-7 py-6 bg-transparent backdrop:blur-lg text-white shadow-lg rounded-lg m-auto ">
      <h2 class="text-2xl font-bold mb-4">Liste de tous vos clients</h2>
      <!-- <p class="mb-8">Payez une fois et profitez de nos forfaits exceptionnels </p> -->
      <table class="table w-full m-auto mt-4 ">
        <thead class="">
          <tr>
            <th class="px-4 py-2 text-left">Identifiant</th>
            <th class="px-4 py-2 text-left">Nom</th>
            <th class="px-4 py-2 text-left">Téléphone</th>
            <th class="px-4 py-2 text-left">Forfait</th>
            <th class="px-4 py-2 text-left">Validité</th>
            <th class="px-4 py-2 text-left">Date d'expiration</th>
            <th class="px-4 py-2 text-left">Temps passé</th>
            <th class="px-4 py-2 text-left">Adresse IP</th>
          </tr>
        </thead>
        <tbody id="users-table-body">
          <!-- User data rows will be added here dynamically -->
        </tbody>
      </table>

    </div>
    <div class="max-w-sm m-auto w-full p-7 py-6 text-black bg-white shadow-lg rounded-lg ">
      <h2 class="text-2xl font-bold mb-4">Ajouter compte </h2>
      <form id="registerForm">
        <div class="mb-4">
          <label class="block text-sm font-medium">Nom:</label>
          <input id="name" type="text" class="w-full border border-gray-300 rounded p-2" placeholder="Martin GANDAHO"
            autocomplete="name" />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium">Numero de telephone: </label>
          <input id="tel" type="tel" class="w-full border border-gray-300 rounded p-2" placeholder="+229 01 96969090"
            autocomplete="tel" />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium">Forfait:</label>
          <select id="package" name="select" class="w-full border border-gray-300 text-slate-700 rounded p-2">
            <!-- <option data-amount="0" value="-">Veuillez choisir un forfait</option> -->
            <option data-amount="200" value="kwaabo">Kwaabo - 2heures - Validité 1 jour</option>
            <option data-amount="500" value="waaba">Waaba - 12h - Validité 3 jours</option>
            <option data-amount="1000" value="semaine">Semaine - 24h - Validité 7 jours</option>
            <option data-amount="2000" value="2Semaines">Semaines - 55h - Validité 14 jours</option>
            <option data-amount="3500" value="mois">Mois - 120h - Validité 30 jours</option>
            <option data-amount="5000" value="illimite">Mois - Illimité - Validité 30 jours</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-slate-500 font-medium">
            Montant:
            <span id="amount" class="text-cyan-600 font-bold ">200 FCFA</span>
          </label>
        </div>

        <p id="errors" class="text-red-500 text-sm pb-4 "></p>

        <button id="pay" type="submit" class="button w-full py-2 cursor-pointer rounded" data-transaction-amount="200"
          data-transaction-description="Acheter mon produit" data-customer-email="johndoe@gmail.com"
          data-customer-lastname="Doe">
          Activer mon
          <span id="packageName" class="font-bold capitalize ">
            Kwaboo
          </span>
        </button>
      </form>
    </div>
  </div>

  <script>
    /*
    fetch('/public/components/footer.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('footer-placeholder').innerHTML = data;
      })
      .catch(error => console.error('Error loading footer:', error));
      */
  </script>

  <script>
    async function fetchUsers() {
      try {
        const response = await fetch(window.location.origin + "/users");
        console.log(response);
        const data = await response.json();


        if (data.users) {
          const tableBody = document.getElementById('users-table-body');
          data.users.forEach(user => {
            const row = document.createElement('tr');
            row.classList.add('border-b', 'border-gray-200');

            row.innerHTML = `
              <td class="px-4 py-2">${user.id}</td>
              <td class="px-4 py-2">${user.name}</td>
              <td class="px-4 py-2">${user.phone}</td>
              <td class="px-4 py-2 capitalize">${user.package}</td>
              <td class="px-4 py-2 capitalize">${user.delay}</td>
              <td class="px-4 py-2">${user.expirationDate || 'Non defini'}</td>
              <td class="px-4 py-2">${user.timePassed || '0'}h</td>
              <td class="px-4 py-2">${user.clientIP}</td>
            `;
            tableBody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error fetching users:', error);
      }
    }

    window.onload = fetchUsers;
  </script>

  <script>
    document.getElementById('logout').addEventListener('click', function () {
      fetch('/logout', { method: 'GET', credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          console.log(data.message);
          // Redirect to home or login page after logout
          window.location.href = '/';
        })
        .catch(error => {
          console.error('Error during logout:', error);
        });
    });
  </script>



<script>
  async function register(event) {
    event.preventDefault(); // Stop the form from submitting normally

    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("tel");
    const packageInput = document.getElementById("package");
    const errorContainer = document.getElementById("errors");

    const name = nameInput.value.trim();
    const phone = phoneInput.value.replace(/\s+/g, ""); // Remove spaces from phone number
    const package = packageInput.value;

    errorContainer.textContent = ""; // Clear previous errors

    if (!name) {
      errorContainer.textContent = "Veuillez saisir votre nom";
      return;
    }
    if (name.length<3) {
      errorContainer.textContent = "Ce nom est trop court";
      return;
    }
    if (!phone) {
      errorContainer.textContent = "Veuillez saisir votre numéro de téléphone.";
      return;
    }
    if (phone.length<8) {
      errorContainer.textContent = "Numéro de téléphone trop court";
      return;
    } else if(phone.length>14){
      errorContainer.textContent = "Numéro de téléphone trop long";
      return;
    }
    if (!package) {
      errorContainer.textContent = "Veuillez choisir un forfait.";
      return;
    }

    try {
      // console.log("Sending data:", { name, phone });
      const response = await fetch(window.location.origin + "/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, phone, package }),
      });

      //console.log("Raw response:", response);  // Log raw response

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || "Erreur d'inscription");
      }

      const data = await response.json();
      //console.log("Response JSON:", data);  // Log the response data

      alert(`Inscription réussie! Le mot de passe est: ${data.password} \nVous pouvez faire une capture d'écran et l'écrire quelque part \n\n${data.password}`);
      window.location.href = "/public/dashboard.html";
      
    } catch (error) {
      console.error("Error occurred:", error);  // Log the error
      errorContainer.textContent = error.message;
    }
  }
</script>

<script>
  document.getElementById("registerForm").addEventListener("submit", register);
</script>

</body>

</html>